# .github/workflows/deploy-powerbi.yml
# Reusable workflow for Power BI deployment
# Repository: your-org/Powerbi-Templates (Template Repository)

name: Deploy Power BI to Workspace

on:
  workflow_call:
    inputs:
      environment:
        description: 'Target environment (dev/uat/prod)'
        required: true
        type: string
      branch:
        description: 'Git branch to deploy from'
        required: true
        type: string
      workspace_id:
        description: 'Target workspace ID'
        required: true
        type: string
      create_release:
        description: 'Create GitHub release (for prod only)'
        required: false
        type: boolean
        default: false
      enable_backup:
        description: 'Create backup before deployment'
        required: false
        type: boolean
        default: false
    secrets:
      AZURE_CLIENT_ID:
        required: true
      AZURE_CLIENT_SECRET:
        required: true
      AZURE_TENANT_ID:
        required: true
    outputs:
      deployment_status:
        description: 'Status of the deployment'
        value: ${{ jobs.deploy.outputs.status }}
      operation_id:
        description: 'Fabric operation ID'
        value: ${{ jobs.deploy.outputs.operation_id }}

env:
  FABRIC_API_BASE_URL: 'https://api.fabric.microsoft.com/v1'

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }} Workspace
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.deployment.outputs.status }}
      operation_id: ${{ steps.deployment.outputs.operation_id }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
      
      - name: Get Access Token for Fabric API
        id: get-token
        run: |
          echo "Getting access token for Fabric API..."
          
          # Get OAuth token using client credentials flow
          TOKEN_RESPONSE=$(curl -s -X POST \
            "https://login.microsoftonline.com/${{ secrets.AZURE_TENANT_ID }}/oauth2/v2.0/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "client_id=${{ secrets.AZURE_CLIENT_ID }}" \
            -d "client_secret=${{ secrets.AZURE_CLIENT_SECRET }}" \
            -d "scope=https://api.fabric.microsoft.com/.default" \
            -d "grant_type=client_credentials")
          
          # Extract access token
          ACCESS_TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.access_token // empty')
          
          if [ -z "$ACCESS_TOKEN" ] || [ "$ACCESS_TOKEN" = "null" ]; then
            echo "Failed to get access token"
            echo "Response: $TOKEN_RESPONSE"
            exit 1
          fi
          
          echo "Successfully obtained access token"
          echo "::add-mask::$ACCESS_TOKEN"
          echo "FABRIC_TOKEN=$ACCESS_TOKEN" >> $GITHUB_ENV
      
      - name: Validate Workspace Connection
        id: validate
        run: |
          echo "Validating workspace connection..."
          WORKSPACE_ID="${{ inputs.workspace_id }}"
          
          # Get workspace details
          WORKSPACE_RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X GET \
            "${{ env.FABRIC_API_BASE_URL }}/workspaces/$WORKSPACE_ID" \
            -H "Authorization: Bearer ${{ env.FABRIC_TOKEN }}")
          
          HTTP_STATUS=$(echo "$WORKSPACE_RESPONSE" | grep HTTP_STATUS | cut -d: -f2)
          BODY=$(echo "$WORKSPACE_RESPONSE" | sed '/HTTP_STATUS/d')
          
          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "Failed to access workspace"
            echo "Status: $HTTP_STATUS"
            echo "Response: $BODY"
            exit 1
          fi
          
          WORKSPACE_NAME=$(echo "$BODY" | jq -r '.displayName')
          echo "Workspace validated: $WORKSPACE_NAME"
          echo "workspace_name=$WORKSPACE_NAME" >> $GITHUB_OUTPUT
      
      - name: Check Git Status
        id: git-status
        run: |
          echo "Checking Git synchronization status..."
          WORKSPACE_ID="${{ inputs.workspace_id }}"
          
          STATUS_RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X GET \
            "${{ env.FABRIC_API_BASE_URL }}/workspaces/$WORKSPACE_ID/git/status" \
            -H "Authorization: Bearer ${{ env.FABRIC_TOKEN }}")
          
          HTTP_STATUS=$(echo "$STATUS_RESPONSE" | grep HTTP_STATUS | cut -d: -f2)
          BODY=$(echo "$STATUS_RESPONSE" | sed '/HTTP_STATUS/d')
          
          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "Failed to get Git status"
            echo "Status: $HTTP_STATUS"
            exit 1
          fi
          
          echo "Git Status Response:"
          echo "$BODY" | jq '.'
          
          # Check if there are incoming changes
          REMOTE_COMMIT=$(echo "$BODY" | jq -r '.remoteCommitHash // empty')
          WORKSPACE_HEAD=$(echo "$BODY" | jq -r '.workspaceHead // empty')
          
          if [ "$REMOTE_COMMIT" != "$WORKSPACE_HEAD" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Incoming changes detected"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No incoming changes - workspace is up to date"
          fi
          
          echo "remote_commit=$REMOTE_COMMIT" >> $GITHUB_OUTPUT
          echo "workspace_head=$WORKSPACE_HEAD" >> $GITHUB_OUTPUT
      
      - name: Create Backup (Optional)
        if: inputs.enable_backup == true
        run: |
          echo "Creating backup of current workspace state..."
          WORKSPACE_ID="${{ inputs.workspace_id }}"
          
          COMMIT_RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST \
            "${{ env.FABRIC_API_BASE_URL }}/workspaces/$WORKSPACE_ID/git/commitToGit" \
            -H "Authorization: Bearer ${{ env.FABRIC_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"mode\": \"All\",
              \"comment\": \"Backup before ${{ inputs.environment }} deployment - $(date -u '+%Y-%m-%d %H:%M:%S UTC')\"
            }")
          
          HTTP_STATUS=$(echo "$COMMIT_RESPONSE" | grep HTTP_STATUS | cut -d: -f2)
          BODY=$(echo "$COMMIT_RESPONSE" | sed '/HTTP_STATUS/d')
          
          if [ "$HTTP_STATUS" -eq 200 ] || [ "$HTTP_STATUS" -eq 202 ]; then
            echo "Backup commit created successfully"
          else
            echo "Backup commit failed (continuing anyway)"
            echo "Status: $HTTP_STATUS"
          fi
      
      - name: Deploy to Workspace
        id: deployment
        if: steps.git-status.outputs.has_changes == 'true'
        run: |
          echo "Starting deployment to ${{ inputs.environment }} workspace..."
          WORKSPACE_ID="${{ inputs.workspace_id }}"
          
          # Determine conflict resolution policy
          if [ "${{ inputs.environment }}" = "dev" ]; then
            CONFLICT_POLICY="PreferWorkspace"
          else
            CONFLICT_POLICY="PreferRemote"
          fi
          
          echo "Using conflict policy: $CONFLICT_POLICY"
          
          # Update workspace from Git
          UPDATE_RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST \
            "${{ env.FABRIC_API_BASE_URL }}/workspaces/$WORKSPACE_ID/git/updateFromGit" \
            -H "Authorization: Bearer ${{ env.FABRIC_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"remoteCommitHash\": \"${{ steps.git-status.outputs.remote_commit }}\",
              \"conflictResolution\": {
                \"conflictResolutionType\": \"Workspace\",
                \"conflictResolutionPolicy\": \"$CONFLICT_POLICY\"
              },
              \"options\": {
                \"allowOverrideItems\": true
              }
            }")
          
          HTTP_STATUS=$(echo "$UPDATE_RESPONSE" | grep HTTP_STATUS | cut -d: -f2)
          BODY=$(echo "$UPDATE_RESPONSE" | sed '/HTTP_STATUS/d')
          
          echo "Update Response (Status: $HTTP_STATUS):"
          echo "$BODY" | jq '.'
          
          if [ "$HTTP_STATUS" -ne 200 ] && [ "$HTTP_STATUS" -ne 202 ]; then
            echo "Deployment request failed"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Check if operation is async (has operation ID)
          OPERATION_ID=$(echo "$BODY" | jq -r '.id // empty')
          
          if [ -n "$OPERATION_ID" ] && [ "$OPERATION_ID" != "null" ]; then
            echo "Operation ID: $OPERATION_ID"
            echo "operation_id=$OPERATION_ID" >> $GITHUB_OUTPUT
            
            # Poll for operation completion
            MAX_ATTEMPTS=60
            ATTEMPT=0
            
            while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
              sleep 10
              ATTEMPT=$((ATTEMPT + 1))
              
              echo "Checking operation status (attempt $ATTEMPT/$MAX_ATTEMPTS)..."
              
              OPERATION_RESPONSE=$(curl -s -X GET \
                "${{ env.FABRIC_API_BASE_URL }}/operations/$OPERATION_ID" \
                -H "Authorization: Bearer ${{ env.FABRIC_TOKEN }}")
              
              STATUS=$(echo "$OPERATION_RESPONSE" | jq -r '.status // "Unknown"')
              echo "Status: $STATUS"
              
              if [ "$STATUS" = "Succeeded" ]; then
                echo "Deployment completed successfully!"
                echo "status=success" >> $GITHUB_OUTPUT
                exit 0
              elif [ "$STATUS" = "Failed" ]; then
                echo "Deployment failed!"
                echo "$OPERATION_RESPONSE" | jq '.'
                echo "status=failed" >> $GITHUB_OUTPUT
                exit 1
              fi
              
              # Continue polling if status is Running, NotStarted, etc.
            done
            
            echo "Operation timed out after $MAX_ATTEMPTS attempts"
            echo "status=timeout" >> $GITHUB_OUTPUT
            exit 1
          else
            # Synchronous operation - completed immediately
            echo "Deployment completed immediately"
            echo "status=success" >> $GITHUB_OUTPUT
          fi
      
      - name: No Changes to Deploy
        if: steps.git-status.outputs.has_changes != 'true'
        run: |
          echo "No incoming changes detected"
          echo "Workspace is already synchronized with Git"
          echo "Remote commit: ${{ steps.git-status.outputs.remote_commit }}"
          echo "Workspace head: ${{ steps.git-status.outputs.workspace_head }}"
      
      - name: Create GitHub Release
        if: inputs.create_release == true && steps.deployment.outputs.status == 'success'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ inputs.environment }}-${{ github.sha }}
          release_name: ${{ inputs.environment }} Release - ${{ github.run_number }}
          body: |
            ## Deployment to ${{ inputs.environment }}
            
            **Environment:** ${{ inputs.environment }}
            **Workspace:** ${{ steps.validate.outputs.workspace_name }}
            **Branch:** ${{ inputs.branch }}
            **Commit:** ${{ github.sha }}
            **Deployed at:** ${{ github.event.head_commit.timestamp }}
            
            ### Changes
            ${{ github.event.head_commit.message }}
          draft: false
          prerelease: ${{ inputs.environment != 'prod' }}
      
      - name: Post Deployment Summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`${{ inputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Workspace** | ${{ steps.validate.outputs.workspace_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Workspace ID** | \`${{ inputs.workspace_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ inputs.branch }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | ${{ steps.deployment.outputs.status || 'no-changes' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Operation ID** | \`${{ steps.deployment.outputs.operation_id || 'N/A' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.deployment.outputs.status }}" = "success" ]; then
            echo "### Deployment Successful" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.git-status.outputs.has_changes }}" != "true" ]; then
            echo "### No Changes to Deploy" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Deployment Failed" >> $GITHUB_STEP_SUMMARY
          fi
