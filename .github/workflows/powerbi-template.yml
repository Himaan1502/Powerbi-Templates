# .github/workflows/deploy-powerbi.yml
# Reusable workflow for Power BI file deployment (Testing - File Upload Only)
# Repository: your-org/Powerbi-Templates (Template Repository)
name: Deploy Power BI Files to Workspace
on:
  workflow_call:
    inputs:
      environment:
        description: 'Target environment (dev/uat/prod)'
        required: true
        type: string
      branch:
        description: 'Git branch to deploy from'
        required: true
        type: string
      workspace_id:
        description: 'Target workspace ID'
        required: true
        type: string
      reports_path:
        description: 'Path to search for .Report and .SemanticModel folders (relative to repo root)'
        required: false
        type: string
        default: '.'
    secrets:
      AZURE_CLIENT_ID:
        required: true
      AZURE_CLIENT_SECRET:
        required: true
      AZURE_TENANT_ID:
        required: true
    outputs:
      deployment_status:
        description: 'Status of the deployment'
        value: ${{ jobs.deploy.outputs.status }}
      deployed_reports:
        description: 'List of deployed reports'
        value: ${{ jobs.deploy.outputs.deployed_reports }}
      deployed_datasets:
        description: 'List of deployed semantic models'
        value: ${{ jobs.deploy.outputs.deployed_datasets }}

env:
  FABRIC_API_BASE_URL: 'https://api.fabric.microsoft.com/v1'

jobs:
  deploy:
    name: Deploy Files to ${{ inputs.environment }} Workspace
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.deployment.outputs.status }}
      deployed_reports: ${{ steps.deployment.outputs.deployed_reports }}
      deployed_datasets: ${{ steps.deployment.outputs.deployed_datasets }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
      
      - name: Get Access Token for Fabric API
        id: get-token
        run: |
          echo "Getting access token for Fabric API..."
          
          # Get OAuth token using client credentials flow
          TOKEN_RESPONSE=$(curl -s -X POST \
            "https://login.microsoftonline.com/${{ secrets.AZURE_TENANT_ID }}/oauth2/v2.0/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "client_id=${{ secrets.AZURE_CLIENT_ID }}" \
            -d "client_secret=${{ secrets.AZURE_CLIENT_SECRET }}" \
            -d "scope=https://api.fabric.microsoft.com/.default" \
            -d "grant_type=client_credentials")
          
          # Extract access token
          ACCESS_TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.access_token // empty')
          
          if [ -z "$ACCESS_TOKEN" ] || [ "$ACCESS_TOKEN" = "null" ]; then
            echo "Failed to get access token"
            echo "Response: $TOKEN_RESPONSE"
            exit 1
          fi
          
          echo "Successfully obtained access token"
          echo "::add-mask::$ACCESS_TOKEN"
          echo "FABRIC_TOKEN=$ACCESS_TOKEN" >> $GITHUB_ENV
      
      - name: Validate Workspace Connection
        id: validate
        run: |
          echo "Validating workspace connection..."
          WORKSPACE_ID="${{ inputs.workspace_id }}"
          
          # Get workspace details
          WORKSPACE_RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X GET \
            "${{ env.FABRIC_API_BASE_URL }}/workspaces/$WORKSPACE_ID" \
            -H "Authorization: Bearer ${{ env.FABRIC_TOKEN }}")
          
          HTTP_STATUS=$(echo "$WORKSPACE_RESPONSE" | grep HTTP_STATUS | cut -d: -f2)
          BODY=$(echo "$WORKSPACE_RESPONSE" | sed '/HTTP_STATUS/d')
          
          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "Failed to access workspace"
            echo "Status: $HTTP_STATUS"
            echo "Response: $BODY"
            exit 1
          fi
          
          WORKSPACE_NAME=$(echo "$BODY" | jq -r '.displayName')
          echo "Workspace validated: $WORKSPACE_NAME"
          echo "workspace_name=$WORKSPACE_NAME" >> $GITHUB_OUTPUT
      
      - name: Find Power BI Items
        id: find-files
        run: |
          echo "Searching for Power BI items in ${{ inputs.reports_path }}..."
          
          if [ ! -d "${{ inputs.reports_path }}" ]; then
            echo "Error: Search path '${{ inputs.reports_path }}' does not exist"
            exit 1
          fi
          
          # Find all .Report folders
          echo "=== Searching for Reports ==="
          REPORT_FOLDERS=$(find "${{ inputs.reports_path }}" -type d -name "*.Report" | sort)
          REPORT_COUNT=$(echo "$REPORT_FOLDERS" | grep -c . || echo "0")
          
          echo "Found $REPORT_COUNT .Report folder(s)"
          
          VALID_REPORTS=0
          > /tmp/reports_to_deploy.txt
          
          if [ "$REPORT_COUNT" -gt 0 ]; then
            while IFS= read -r FOLDER; do
              [ -z "$FOLDER" ] && continue
              PBIR_FILE="$FOLDER/definition.pbir"
              
              if [ -f "$PBIR_FILE" ]; then
                echo "  ✓ $FOLDER"
                echo "$FOLDER" >> /tmp/reports_to_deploy.txt
                VALID_REPORTS=$((VALID_REPORTS + 1))
              else
                echo "  ✗ $FOLDER (missing definition.pbir)"
              fi
            done <<< "$REPORT_FOLDERS"
          fi
          
          # Find all .SemanticModel folders
          echo ""
          echo "=== Searching for Semantic Models ==="
          DATASET_FOLDERS=$(find "${{ inputs.reports_path }}" -type d -name "*.SemanticModel" | sort)
          DATASET_COUNT=$(echo "$DATASET_FOLDERS" | grep -c . || echo "0")
          
          echo "Found $DATASET_COUNT .SemanticModel folder(s)"
          
          VALID_DATASETS=0
          > /tmp/datasets_to_deploy.txt
          
          if [ "$DATASET_COUNT" -gt 0 ]; then
            while IFS= read -r FOLDER; do
              [ -z "$FOLDER" ] && continue
              PBISM_FILE="$FOLDER/definition.pbism"
              
              if [ -f "$PBISM_FILE" ]; then
                echo "  ✓ $FOLDER"
                echo "$FOLDER" >> /tmp/datasets_to_deploy.txt
                VALID_DATASETS=$((VALID_DATASETS + 1))
              else
                echo "  ✗ $FOLDER (missing definition.pbism)"
              fi
            done <<< "$DATASET_FOLDERS"
          fi
          
          echo ""
          echo "=== Summary ==="
          echo "Valid reports to deploy: $VALID_REPORTS"
          echo "Valid semantic models to deploy: $VALID_DATASETS"
          
          TOTAL_ITEMS=$((VALID_REPORTS + VALID_DATASETS))
          
          if [ "$TOTAL_ITEMS" -eq 0 ]; then
            echo "No valid Power BI items found"
            exit 1
          fi
          
          echo "report_count=$VALID_REPORTS" >> $GITHUB_OUTPUT
          echo "dataset_count=$VALID_DATASETS" >> $GITHUB_OUTPUT
          echo "total_count=$TOTAL_ITEMS" >> $GITHUB_OUTPUT
      
      - name: Deploy Semantic Models to Workspace
        id: deploy-datasets
        run: |
          echo "=========================================="
          echo "DEPLOYING SEMANTIC MODELS"
          echo "=========================================="
          
          WORKSPACE_ID="${{ inputs.workspace_id }}"
          DEPLOYED_DATASETS=""
          SUCCESS_COUNT=0
          FAILED_COUNT=0
          
          if [ ! -f /tmp/datasets_to_deploy.txt ] || [ ! -s /tmp/datasets_to_deploy.txt ]; then
            echo "No semantic models to deploy"
            echo "deployed_datasets=" >> $GITHUB_OUTPUT
            echo "dataset_success=0" >> $GITHUB_OUTPUT
            echo "dataset_failed=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Deploy each semantic model
          while IFS= read -r DATASET_FOLDER; do
            [ -z "$DATASET_FOLDER" ] && continue
            
            DATASET_NAME=$(basename "$DATASET_FOLDER" .SemanticModel)
            
            echo ""
            echo "================================================"
            echo "Deploying Semantic Model: $DATASET_NAME"
            echo "Folder: $DATASET_FOLDER"
            echo "================================================"
            
            # Build definition payload from all files in definition folder
            PAYLOAD_PARTS="["
            FIRST_FILE=true
            
            # Process all files in the definition folder
            if [ -d "$DATASET_FOLDER/definition" ]; then
              while IFS= read -r FILE; do
                [ -z "$FILE" ] && continue
                
                RELATIVE_PATH="${FILE#$DATASET_FOLDER/definition/}"
                FILE_CONTENT=$(base64 -w 0 < "$FILE")
                
                if [ "$FIRST_FILE" = false ]; then
                  PAYLOAD_PARTS="$PAYLOAD_PARTS,"
                fi
                FIRST_FILE=false
                
                PAYLOAD_PARTS="$PAYLOAD_PARTS{\"path\":\"$RELATIVE_PATH\",\"payload\":\"$FILE_CONTENT\",\"payloadType\":\"InlineBase64\"}"
                
              done < <(find "$DATASET_FOLDER/definition" -type f)
            fi
            
            PAYLOAD_PARTS="$PAYLOAD_PARTS]"
            
            # Create semantic model in workspace
            RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST \
              "${{ env.FABRIC_API_BASE_URL }}/workspaces/$WORKSPACE_ID/semanticModels" \
              -H "Authorization: Bearer ${{ env.FABRIC_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d "{\"displayName\":\"$DATASET_NAME\",\"definition\":{\"parts\":$PAYLOAD_PARTS}}")
            
            HTTP_STATUS=$(echo "$RESPONSE" | grep HTTP_STATUS | cut -d: -f2)
            BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS/d')
            
            if [ "$HTTP_STATUS" -eq 200 ] || [ "$HTTP_STATUS" -eq 201 ] || [ "$HTTP_STATUS" -eq 202 ]; then
              DATASET_ID=$(echo "$BODY" | jq -r '.id // "unknown"')
              echo "✓ Successfully deployed: $DATASET_NAME"
              echo "  Semantic Model ID: $DATASET_ID"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              DEPLOYED_DATASETS="$DEPLOYED_DATASETS$DATASET_NAME, "
            else
              echo "✗ Failed to deploy: $DATASET_NAME"
              echo "  Status: $HTTP_STATUS"
              echo "  Response: $BODY"
              FAILED_COUNT=$((FAILED_COUNT + 1))
            fi
            
          done < /tmp/datasets_to_deploy.txt
          
          DEPLOYED_DATASETS=${DEPLOYED_DATASETS%, }
          
          echo ""
          echo "=== Semantic Models Deployment Summary ==="
          echo "Total: ${{ steps.find-files.outputs.dataset_count }}"
          echo "Success: $SUCCESS_COUNT"
          echo "Failed: $FAILED_COUNT"
          echo "=========================================="
          
          echo "deployed_datasets=$DEPLOYED_DATASETS" >> $GITHUB_OUTPUT
          echo "dataset_success=$SUCCESS_COUNT" >> $GITHUB_OUTPUT
          echo "dataset_failed=$FAILED_COUNT" >> $GITHUB_OUTPUT
      
      - name: Deploy Reports to Workspace
        id: deploy-reports
        run: |
          echo "=========================================="
          echo "DEPLOYING REPORTS"
          echo "=========================================="
          
          WORKSPACE_ID="${{ inputs.workspace_id }}"
          DEPLOYED_REPORTS=""
          SUCCESS_COUNT=0
          FAILED_COUNT=0
          
          if [ ! -f /tmp/reports_to_deploy.txt ] || [ ! -s /tmp/reports_to_deploy.txt ]; then
            echo "No reports to deploy"
            echo "deployed_reports=" >> $GITHUB_OUTPUT
            echo "report_success=0" >> $GITHUB_OUTPUT
            echo "report_failed=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Deploy each report
          while IFS= read -r REPORT_FOLDER; do
            [ -z "$REPORT_FOLDER" ] && continue
            
            REPORT_NAME=$(basename "$REPORT_FOLDER" .Report)
            
            echo ""
            echo "================================================"
            echo "Deploying Report: $REPORT_NAME"
            echo "Folder: $REPORT_FOLDER"
            echo "================================================"
            
            # Build definition payload from all files in definition folder
            PAYLOAD_PARTS="["
            FIRST_FILE=true
            
            # Process all files in the definition folder
            if [ -d "$REPORT_FOLDER/definition" ]; then
              while IFS= read -r FILE; do
                [ -z "$FILE" ] && continue
                
                RELATIVE_PATH="${FILE#$REPORT_FOLDER/definition/}"
                FILE_CONTENT=$(base64 -w 0 < "$FILE")
                
                if [ "$FIRST_FILE" = false ]; then
                  PAYLOAD_PARTS="$PAYLOAD_PARTS,"
                fi
                FIRST_FILE=false
                
                PAYLOAD_PARTS="$PAYLOAD_PARTS{\"path\":\"$RELATIVE_PATH\",\"payload\":\"$FILE_CONTENT\",\"payloadType\":\"InlineBase64\"}"
                
              done < <(find "$REPORT_FOLDER/definition" -type f)
            fi
            
            PAYLOAD_PARTS="$PAYLOAD_PARTS]"
            
            # Create report in workspace
            RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST \
              "${{ env.FABRIC_API_BASE_URL }}/workspaces/$WORKSPACE_ID/reports" \
              -H "Authorization: Bearer ${{ env.FABRIC_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d "{\"displayName\":\"$REPORT_NAME\",\"definition\":{\"parts\":$PAYLOAD_PARTS}}")
            
            HTTP_STATUS=$(echo "$RESPONSE" | grep HTTP_STATUS | cut -d: -f2)
            BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS/d')
            
            if [ "$HTTP_STATUS" -eq 200 ] || [ "$HTTP_STATUS" -eq 201 ] || [ "$HTTP_STATUS" -eq 202 ]; then
              REPORT_ID=$(echo "$BODY" | jq -r '.id // "unknown"')
              echo "✓ Successfully deployed: $REPORT_NAME"
              echo "  Report ID: $REPORT_ID"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              DEPLOYED_REPORTS="$DEPLOYED_REPORTS$REPORT_NAME, "
            else
              echo "✗ Failed to deploy: $REPORT_NAME"
              echo "  Status: $HTTP_STATUS"
              echo "  Response: $BODY"
              FAILED_COUNT=$((FAILED_COUNT + 1))
            fi
            
          done < /tmp/reports_to_deploy.txt
          
          DEPLOYED_REPORTS=${DEPLOYED_REPORTS%, }
          
          echo ""
          echo "=== Reports Deployment Summary ==="
          echo "Total: ${{ steps.find-files.outputs.report_count }}"
          echo "Success: $SUCCESS_COUNT"
          echo "Failed: $FAILED_COUNT"
          echo "=========================================="
          
          echo "deployed_reports=$DEPLOYED_REPORTS" >> $GITHUB_OUTPUT
          echo "report_success=$SUCCESS_COUNT" >> $GITHUB_OUTPUT
          echo "report_failed=$FAILED_COUNT" >> $GITHUB_OUTPUT
      
      - name: Final Deployment Status
        id: deployment
        run: |
          DATASET_SUCCESS=${{ steps.deploy-datasets.outputs.dataset_success || 0 }}
          DATASET_FAILED=${{ steps.deploy-datasets.outputs.dataset_failed || 0 }}
          REPORT_SUCCESS=${{ steps.deploy-reports.outputs.report_success || 0 }}
          REPORT_FAILED=${{ steps.deploy-reports.outputs.report_failed || 0 }}
          
          TOTAL_SUCCESS=$((DATASET_SUCCESS + REPORT_SUCCESS))
          TOTAL_FAILED=$((DATASET_FAILED + REPORT_FAILED))
          TOTAL_ITEMS=${{ steps.find-files.outputs.total_count }}
          
          echo ""
          echo "=========================================="
          echo "OVERALL DEPLOYMENT SUMMARY"
          echo "=========================================="
          echo "Semantic Models: $DATASET_SUCCESS deployed, $DATASET_FAILED failed"
          echo "Reports: $REPORT_SUCCESS deployed, $REPORT_FAILED failed"
          echo "----------------------------------------"
          echo "Total: $TOTAL_SUCCESS/$TOTAL_ITEMS succeeded"
          echo "=========================================="
          
          if [ $TOTAL_FAILED -eq 0 ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "✅ All items deployed successfully!"
          elif [ $TOTAL_SUCCESS -gt 0 ]; then
            echo "status=partial" >> $GITHUB_OUTPUT
            echo "⚠️ Some items failed to deploy"
            exit 1
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "❌ All deployments failed"
            exit 1
          fi
      
      - name: Post Deployment Summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`${{ inputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Workspace** | ${{ steps.validate.outputs.workspace_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Workspace ID** | \`${{ inputs.workspace_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ inputs.branch }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | ${{ steps.deployment.outputs.status || 'failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Semantic Models" >> $GITHUB_STEP_SUMMARY
          echo "- **Found:** ${{ steps.find-files.outputs.dataset_count || '0' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed:** ${{ steps.deploy-datasets.outputs.dataset_success || '0' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** ${{ steps.deploy-datasets.outputs.dataset_failed || '0' }}" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ steps.deploy-datasets.outputs.deployed_datasets }}" ]; then
            echo "- **Items:** ${{ steps.deploy-datasets.outputs.deployed_datasets }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Reports" >> $GITHUB_STEP_SUMMARY
          echo "- **Found:** ${{ steps.find-files.outputs.report_count || '0' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed:** ${{ steps.deploy-reports.outputs.report_success || '0' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** ${{ steps.deploy-reports.outputs.report_failed || '0' }}" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ steps.deploy-reports.outputs.deployed_reports }}" ]; then
            echo "- **Items:** ${{ steps.deploy-reports.outputs.deployed_reports }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.deployment.outputs.status }}" = "success" ]; then
            echo "✅ **All items deployed successfully**" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.deployment.outputs.status }}" = "partial" ]; then
            echo "⚠️ **Some items failed to deploy**" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Deployment failed**" >> $GITHUB_STEP_SUMMARY
          fi
